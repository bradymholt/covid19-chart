<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Confirmed COVID-19 Cases</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    <style>
      body {
        font: 0.8rem Arial;
      }

      path.country-1 {
        stroke: steelblue;
        stroke-width: 2;
        fill: none;
      }

      .legend.country-1 {
        fill: steelblue;
      }

      path.country-2 {
        stroke: blueviolet;
        stroke-width: 2;
        fill: none;
      }

      .legend.country-2 {
        fill: blueviolet;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
      }

      main {
        width: 1264px;
        height: 503px;
      }

      .selection {
        display: flex;
      }

      label {
        margin: 0 10px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Confirmed COVID-19 Cases</h1>
    <div class="selection">
      <label for="country-1">Country 1:</label>
      <select id="country-1"></select>
      <label for="country-2">Country 2:</label>
      <select id="country-2"></select>
    </div>
    <main></main>
    <footer>
      <strong>Source:</strong> The data comes from the
      <a href="https://github.com/CSSEGISandData/COVID-19"
        >COVID-19 (2019-nCoV) Data Repository by Johns Hopkins CSSE</a
      >
      and is pulled from the API at
      <a href="https://coronavirus-tracker-api.herokuapp.com/confirmed"
        >https://coronavirus-tracker-api.herokuapp.com/confirmed</a
      >
      (Source code:
      <a href="https://github.com/ExpDev07/coronavirus-tracker-api"
        >https://github.com/ExpDev07/coronavirus-tracker-api</a
      >).
    </footer>
    <script>
      function downloadData() {
        return fetch(
          "https://coronavirus-tracker-api.herokuapp.com/confirmed"
        ).then(response => response.json());
      }

      function setupDropdowns(chartData, rawData) {
        const countries = _.uniq(
          rawData.locations.map(l => l.country)
        ).sort((a, b) => a.localeCompare(b));
        const country1Select = document.getElementById("country-1");
        const country2Select = document.getElementById("country-2");

        for (let countryName of countries) {
          const el = document.createElement("option");
          el.textContent = countryName;
          el.value = countryName;
          const el2 = el.cloneNode(true);

          if (el.value == "US") {
            el.setAttribute("selected", "selected");
          }

          if (el2.value == "Italy") {
            el2.setAttribute("selected", "selected");
          }

          country1Select.appendChild(el);
          country2Select.appendChild(el2);
        }

        country1Select.addEventListener("change", event => {
          updateChart(chartConfig, rawData, country1Select, country2Select);
        });

        country2Select.addEventListener("change", event => {
          updateChart(chartConfig, rawData, country1Select, country2Select);
        });

        return { country1Select, country2Select };
      }

      function setupChart() {
        // Set the dimensions and margins of the graph
        const margin = { top: 30, right: 100, bottom: 30, left: 50 },
          width = 960 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

        // Setup ranges
        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        // Append the svg object to the body of the page
        var svg = d3
          .select("main")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        return { svg, x, y, width, height };
      }

      function gatherChartData(data, country1, country2) {
        let usData = null;
        if (country1 == "US" || country2 == "US") {
          usData = data.locations
            .filter(d => d.country == "US" && d.province.indexOf(", ") == -1)
            .map(p => p.history)
            .reduce((result, c) => {
              Object.keys(c).forEach(day => {
                result[day] = (result[day] || 0) + c[day];
              });
              return result;
            }, {});
        }
        const getCountryData = country =>
          data.locations.find(d => d.country == country).history;

        const country1Data =
          country1 == "US" ? usData : getCountryData(country1);
        const country2Data =
          country2 == "US" ? usData : getCountryData(country2);

        const mergedData = _.mergeWith(
          country1Data,
          country2Data,
          (target, current) => {
            return [target, current];
          }
        );

        let chartData = Object.keys(mergedData)
          .map(k => {
            return {
              date: parseTime(k),
              country1Confirmed: +mergedData[k][0],
              country2Confirmed: +mergedData[k][1]
            };
          })
          .sort((a, b) => a.date - b.date);

        return { countries: [country1, country2], data: chartData };
      }

      function renderData(chartConfig, chartData) {
        // Remove any previous lines
        d3.selectAll("g > *").remove();

        const data = chartData.data;
        // Scale the range of the data
        chartConfig.x.domain(
          d3.extent(data, function(d) {
            return d.date;
          })
        );
        chartConfig.y.domain([
          0,
          d3.max(data, function(d) {
            return Math.max(d.country1Confirmed, d.country2Confirmed);
          })
        ]);

        // Define the series lines
        var country1Line = d3
          .line()
          .x(function(d) {
            return chartConfig.x(d.date);
          })
          .y(function(d) {
            return chartConfig.y(d.country1Confirmed);
          });

        var country2Line = d3
          .line()
          .x(function(d) {
            return chartConfig.x(d.date);
          })
          .y(function(d) {
            return chartConfig.y(d.country2Confirmed);
          });

        // Add the country1Line path
        chartConfig.svg
          .append("path")
          .data([data])
          .attr("class", "line country-1")
          .attr("d", country1Line);

        // Add the country2Line path
        chartConfig.svg
          .append("path")
          .data([data])
          .attr("class", "line country-2")
          .attr("d", country2Line);

        // Add legend for country 1
        chartConfig.svg
          .append("text")
          .attr(
            "transform",
            "translate(" +
              (chartConfig.width + 3) +
              "," +
              chartConfig.y(data[data.length - 1].country1Confirmed) +
              ")"
          )
          .attr("dy", ".35em")
          .attr("text-anchor", "start")
          .attr("class", "legend country-1")
          .text(chartData.countries[0]);

        // Add legend for country 2
        chartConfig.svg
          .append("text")
          .attr(
            "transform",
            "translate(" +
              (chartConfig.width + 3) +
              "," +
              chartConfig.y(data[data.length - 1].country2Confirmed) +
              ")"
          )
          .attr("dy", ".35em")
          .attr("text-anchor", "start")
          .attr("class", "legend country-2")
          .text(chartData.countries[1]);

        // Add the x Axis
        chartConfig.svg
          .append("g")
          .attr("transform", "translate(0," + chartConfig.height + ")")
          .call(d3.axisBottom(chartConfig.x));

        // Add the y Axis
        chartConfig.svg.append("g").call(d3.axisLeft(chartConfig.y));
      }

      function updateChart(
        chartConfig,
        rawData,
        country1Select,
        country2Select
      ) {
        const country1 =
          country1Select.options[country1Select.selectedIndex].value;
        const country2 =
          country2Select.options[country2Select.selectedIndex].value;

        const chartData = gatherChartData(rawData, country1, country2);

        renderData(chartConfig, chartData);
      }

      // Define function for parsing date
      const parseTime = d3.timeParse("%m/%d/%y");

      document.addEventListener("DOMContentLoaded", event => {
        downloadData().then(rawData => {
          const chartConfig = setupChart();
          const { country1Select, country2Select } = setupDropdowns(
            chartConfig,
            rawData
          );

          // Initially render the chart
          updateChart(chartConfig, rawData, country1Select, country2Select);          
        });
      });
    </script>
  </body>
</html>
